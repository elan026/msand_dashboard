{% extends 'layout.html' %} {% block content %}
<div class="card-modern">
  <div class="row g-3">
    <div class="col-lg-7">
      <h3>Upload sample</h3>
      <p class="small-note">
        Upload an image from mobile or web and include sensor readings.
      </p>
      <form
        id="uploadForm"
        action="{{ url_for('upload') }}"
        method="post"
        enctype="multipart/form-data"
      >
        <div class="mb-3">
          <label class="small-note">Device ID</label>
          <input class="form-control" name="device_id" value="web-client" />
        </div>
        <div class="row">
          <div class="col-sm-4 mb-3">
            <label class="small-note">Temperature (Â°C)</label>
            <input class="form-control" name="temp" placeholder="28.5" />
          </div>
          <div class="col-sm-4 mb-3">
            <label class="small-note">Humidity (%)</label>
            <input class="form-control" name="humidity" placeholder="45" />
          </div>
          <div class="col-sm-4 mb-3">
            <label class="small-note">Moisture (%)</label>
            <input class="form-control" name="moisture" placeholder="12" />
          </div>
        </div>
        <div class="mb-3">
          <label class="small-note">Image</label>
          <input
            type="file"
            class="form-control"
            id="imageInput"
            name="image"
            accept="image/*"
            required
          />
        </div>
        <div class="d-flex gap-2 align-items-center">
          <button class="btn btn-accent" type="submit">Upload & Analyze</button>
          <div id="uploadStatus" class="small-note"></div>
        </div>
      </form>
    </div>
    <div class="col-lg-5">
      <div class="small-note">Preview</div>
      <div class="file-preview mt-2 p-2 bg-dark">
        <img id="previewImg" src="" alt="" style="width: 100%; display: none" />
        <div id="previewEmpty" class="small-note">No image selected</div>
      </div>
      <div id="resultArea" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
  const form = document.getElementById("uploadForm");
  const imgInput = document.getElementById("imageInput");
  const previewImg = document.getElementById("previewImg");
  const previewEmpty = document.getElementById("previewEmpty");
  imgInput.addEventListener("change", () => {
    const f = imgInput.files && imgInput.files[0];
    if (!f) {
      previewImg.style.display = "none";
      previewEmpty.style.display = "block";
      return;
    }
    const url = URL.createObjectURL(f);
    previewImg.src = url;
    previewImg.style.display = "block";
    previewEmpty.style.display = "none";
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    document.getElementById("uploadStatus").innerText = "Uploading...";
    try {
      const res = await fetch(form.action, { method: "POST", body: fd });
      const data = await res.json();
      document.getElementById("uploadStatus").innerText = "";
      if (data.success) {
        document.getElementById("resultArea").innerHTML = `
        <div class="card-modern p-3 mt-2">
          <div class="result-label">${data.label} <span class="small-note">(${(
          data.confidence * 100
        ).toFixed(1)}%)</span></div>
          <img src="${data.segmented_url}" class="img-fluid mt-2" />
        </div>
      `;
      } else {
        document.getElementById("resultArea").innerText =
          "Error: " + (data.error || "unknown");
      }
    } catch (err) {
      document.getElementById("uploadStatus").innerText = "";
      document.getElementById("resultArea").innerText =
        "Upload failed: " + err.message;
    }
  });
</script>
{% endblock %}
